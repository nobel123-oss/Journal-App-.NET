@page "/timeline"
@inject IJournalRepository Repository
@inject NavigationManager Navigation

<div class="page-container">
    <div class="page-header">
        <h1>Timeline</h1>
        <p class="page-subtitle">Browse all your journal entries</p>
    </div>

    <div class="timeline-filters">
        <input type="text"
               value="@searchTerm"
               @oninput="OnSearchInput"
               placeholder="Search entries..."
               class="search-input" />

        
        <button @onclick="ToggleFilters" class="btn-secondary">
            @(showFilters ? "Hide Filters" : "Show Filters")
        </button>
    </div>

    @if (showFilters)
    {
        <FilterBar 
            Moods="@moods"
            Tags="@tags"
            OnFilter="@HandleFilter" />
    }

    @if (isLoading)
    {
        <p>Loading...</p>
    }
    else if (!entries.Any())
    {
        <div class="empty-state">
            <p>No entries found</p>
            <button @onclick="GoToToday" class="btn-primary">Create Your First Entry</button>
        </div>
    }
    else
    {
        <div class="timeline-list">
            @foreach (var entry in entries)
            {
                <EntryRow Entry="@entry" OnClick="() => ViewEntry(entry.Id)" />
            }
        </div>

        @if (totalPages > 1)
        {
            <div class="pagination">
                <button @onclick="PreviousPage" disabled="@(currentPage == 1)" class="btn-secondary">
                    Previous
                </button>
                
                <span class="page-info">Page @currentPage of @totalPages</span>
                
                <button @onclick="NextPage" disabled="@(currentPage >= totalPages)" class="btn-secondary">
                    Next
                </button>
            </div>
        }
    }
</div>

@code {
    private bool isLoading = true;
    private bool showFilters = false;
    private string searchTerm = string.Empty;
    private List<JournalEntry> entries = new();
    private List<Mood> moods = new();
    private List<Tag> tags = new();

    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private int totalCount = 0;

    private DateTime? filterStartDate;
    private DateTime? filterEndDate;
    private List<int>? filterMoodIds;
    private List<int>? filterTagIds;

    protected override async Task OnInitializedAsync()
    {
        moods = await Repository.GetAllMoodsAsync();
        tags = await Repository.GetAllTagsAsync();
        await LoadEntries();
        isLoading = false;
    }
    private async Task OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        currentPage = 1;
        await LoadEntries();
    }

    private async Task LoadEntries()
    {
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            entries = await Repository.SearchEntriesAsync(searchTerm);
            totalCount = entries.Count;
            totalPages = 1;
        }
        else if (filterStartDate.HasValue || filterEndDate.HasValue || 
                 (filterMoodIds != null && filterMoodIds.Any()) || 
                 (filterTagIds != null && filterTagIds.Any()))
        {
            entries = await Repository.FilterEntriesAsync(filterStartDate, filterEndDate, filterMoodIds, filterTagIds);
            totalCount = entries.Count;
            totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);
            entries = entries.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();
        }
        else
        {
            var result = await Repository.GetEntriesPaginatedAsync(currentPage, pageSize);
            entries = result.Entries;
            totalCount = result.TotalCount;
            totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);
        }
    }

    private async Task HandleFilter((DateTime? startDate, DateTime? endDate, List<int>? moodIds, List<int>? tagIds) f)
    {
        filterStartDate = f.startDate;
        filterEndDate = f.endDate;
        filterMoodIds = f.moodIds;
        filterTagIds = f.tagIds;

        currentPage = 1;
        await LoadEntries();
    }


    private void ToggleFilters()
    {
        showFilters = !showFilters;
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadEntries();
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadEntries();
        }
    }

    private void ViewEntry(int id)
    {
        Navigation.NavigateTo($"/today?id={id}");
    }

    private void GoToToday()
    {
        Navigation.NavigateTo("/today");
    }
}
